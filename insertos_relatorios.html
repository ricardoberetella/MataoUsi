<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Relatórios de Movimentação - Matão Usinagem</title>

<link rel="stylesheet" href="css/dashboard.css">
<script type="module" src="js/auth.js"></script>

<style>
body{
    background:#0b0e14;
    font-family:Segoe UI,Arial;
    margin:0;
}

.container{
    padding:30px;
    max-width:1200px;
    margin:auto;
}

/* HEADER PADRÃO SISTEMA */
.header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:25px;
    flex-wrap:wrap;
    gap:15px;
}

.btn{
    padding:12px 18px;
    border-radius:12px;
    font-weight:800;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    gap:10px;
    border:1px solid rgba(255,255,255,0.12);
    cursor:pointer;
    transition:.18s;
}
.btn:hover{ filter:brightness(1.05); }

.btn-sec{
    background:#1f2937;
    color:#fff;
}

.btn-pri{
    background:#38bdf8;
    color:#0b0e14;
}

/* TABELA */
.table{
    width:100%;
    border-collapse:collapse;
    background:#111827;
    border-radius:16px;
    overflow:hidden;
    border:1px solid #1f2937;
}

.table th{
    background:#1f2937;
    color:#38bdf8;
    padding:18px;
    text-align:left;
}

.table td{
    padding:18px;
    border-bottom:1px solid #1f2937;
    color:#e5e7eb;
}
</style>
</head>

<body>

<div class="container">

    <div class="header">
        <a href="insertos_lista.html" class="btn btn-sec">← Voltar para Lista</a>

        <h1 style="color:white;margin:0;font-size:36px;">
            Relatórios de Movimentação
        </h1>

        <a href="insertos_novo.html" class="btn btn-pri">+ Novo Inserto</a>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>Data</th>
                <th>Inserto</th>
                <th>Tipo</th>
                <th>Qtd</th>
                <th>Observação</th>
            </tr>
        </thead>
        <tbody id="corpoRelatorio"></tbody>
    </table>

</div>

<script type="module">
import { supabase } from "./js/auth.js";

document.addEventListener("DOMContentLoaded", carregarRelatorio);

function formatarDataHoraBR(iso){
    if(!iso) return "-";
    const d = new Date(iso);
    const data = d.toLocaleDateString("pt-BR");
    const hora = d.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
    return `${data} ${hora}`;
}

function escapeHtml(str){
    return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
}

async function carregarRelatorio(){
    const tbody = document.getElementById("corpoRelatorio");
    tbody.innerHTML = `<tr><td colspan="5">Carregando...</td></tr>`;

    const { data, error } = await supabase
        .from("insertos_movimentacoes")
        .select("id, inserto_id, tipo, quantidade, data, observacao, insertos(descricao)")
        .order("data", { ascending: false });

    if(error){
        console.error(error);
        tbody.innerHTML = `<tr><td colspan="5">Erro ao carregar relatório.</td></tr>`;
        return;
    }

    if(!data || data.length === 0){
        tbody.innerHTML = `<tr><td colspan="5">Nenhuma movimentação encontrada.</td></tr>`;
        return;
    }

    tbody.innerHTML = data.map(mov=>{
        const desc = escapeHtml(mov.insertos?.descricao || "N/A");
        const tipo = mov.tipo === "entrada" ? "entrada" : "saida";
        const cor = tipo === "entrada" ? "#10b981" : "#f59e0b";
        const sinal = tipo === "entrada" ? "+" : "-";
        const obs = escapeHtml(mov.observacao || "-");

        return `
        <tr>
            <td>${formatarDataHoraBR(mov.data)}</td>
            <td style="color:#38bdf8;font-weight:bold;">${desc}</td>
            <td style="color:${cor};font-weight:800;text-transform:capitalize;">${tipo}</td>
            <td style="font-weight:900;">${sinal}${Number(mov.quantidade)}</td>
            <td style="color:#9ca3af;">${obs}</td>
        </tr>
        `;
    }).join("");
}
</script>

</body>
</html>
