<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Inserto - Matão Usinagem</title>

  <link rel="stylesheet" href="css/dashboard.css">
  <script type="module" src="js/auth.js"></script>

  <style>
    body{ background:#0b0e14; padding:20px; font-family:Segoe UI,Arial; }
    .box{
      max-width: 650px;
      margin: 50px auto;
      background: rgba(17,24,39,0.92);
      padding: 40px;
      border-radius: 16px;
      border: 1px solid rgba(55,65,81,0.70);
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
    }
    .label{ color:#38bdf8; font-weight:900; display:block; margin-bottom:10px; }
    .input{
      width:100%;
      background:#1f2937;
      border:1px solid #374151;
      color:white;
      padding:15px;
      border-radius:12px;
      font-weight:800;
      outline:none;
    }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    @media(max-width:700px){ .row{ grid-template-columns:1fr; } }

    .btn{
      width:100%;
      border:none;
      padding:18px;
      border-radius:12px;
      font-weight:1000;
      cursor:pointer;
      transition:.18s;
      user-select:none;
    }
    .btn:active{ transform:translateY(1px); }
    .btn:hover{ filter:brightness(1.05); }

    .btn-salvar{ background:#38bdf8; color:#0b0e14; }
    .link{
      display:block;
      text-align:center;
      margin-top:20px;
      color:#9ca3af;
      text-decoration:none;
      font-weight:800;
    }
  </style>
</head>

<body>

  <div class="box">
    <h2 style="color:white; margin:0 0 30px 0; font-size:30px;">Editar Inserto</h2>

    <input type="hidden" id="ins_id">

    <div style="margin-bottom:20px;">
      <label class="label">Descrição do Inserto</label>
      <input type="text" id="ins_descricao" class="input" placeholder="Ex: TNMG">
    </div>

    <div class="row" style="margin-bottom:30px;">
      <div>
        <label class="label">Marca</label>
        <input type="text" id="ins_marca" class="input" placeholder="SUMITOMO">
      </div>
      <div>
        <label class="label">Quantidade</label>
        <input type="number" id="ins_quantidade" class="input" value="0">
      </div>
    </div>

    <button id="btnSalvar" class="btn btn-salvar">Salvar Alterações</button>
    <a href="insertos_lista.html" class="link">Cancelar e Voltar</a>
  </div>

<script type="module">
import { supabase } from "./js/auth.js";

document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(window.location.search);
  const id = params.get("id");

  if(!id){
    alert("ID não informado.");
    window.location.href = "insertos_lista.html";
    return;
  }

  document.getElementById("ins_id").value = id;

  // Carrega dados
  const { data, error } = await supabase
    .from("insertos")
    .select("id, descricao, marca, quantidade")
    .eq("id", id)
    .single();

  if(error){
    console.error(error);
    alert("Erro ao carregar inserto.");
    window.location.href = "insertos_lista.html";
    return;
  }

  document.getElementById("ins_descricao").value = data.descricao || "";
  document.getElementById("ins_marca").value = data.marca || "";
  document.getElementById("ins_quantidade").value = Number(data.quantidade ?? 0);

  document.getElementById("btnSalvar").addEventListener("click", salvar);
});

async function salvar(){
  const id = document.getElementById("ins_id").value;
  const descricao = String(document.getElementById("ins_descricao").value || "").trim();
  const marca = String(document.getElementById("ins_marca").value || "").trim();
  const qtd = parseInt(String(document.getElementById("ins_quantidade").value || "0"), 10);

  if(!descricao) return alert("A descrição é obrigatória!");
  if(!Number.isFinite(qtd) || qtd < 0) return alert("Quantidade inválida.");

  const { error } = await supabase
    .from("insertos")
    .update({ descricao, marca: marca || null, quantidade: qtd })
    .eq("id", id);

  if(error){
    console.error(error);
    alert("Erro ao salvar.");
    return;
  }

  alert("Inserto atualizado!");
  window.location.href = "insertos_lista.html";
}
</script>

</body>
</html>
