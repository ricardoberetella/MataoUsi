<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Zincagem / Tratamento</title>

<link rel="stylesheet" href="css/dashboard.css" />

<style>
  /* ===== FIX CORTE TOPO ===== */
  html, body { height: 100%; }
  body{
    margin:0;
    background: radial-gradient(circle at top, #0b1224, #020617 70%);
    color:#e5e7eb;
    overflow-x:hidden;
  }

  /* header fixo, não corta */
  .zt-header{
    position: sticky;
    top: 0;
    z-index: 50;
    background: rgba(2, 6, 23, .92);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid rgba(56, 189, 248, .15);
    padding: 18px 22px;
  }
  .zt-header .row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    flex-wrap: wrap;
  }
  .zt-title{
    margin:0;
    font-size: 28px;
    letter-spacing:.3px;
    color:#38bdf8;
    line-height:1.15;
  }
  .zt-actions{
    display:flex;
    gap:10px;
    flex-wrap: wrap;
  }

  /* conteúdo */
  .zt-main{
    padding: 18px 22px 28px;
  }

  /* tabela */
  .zt-table{
    width:100%;
    border-collapse: collapse;
    background: rgba(2, 11, 26, .55);
    border: 1px solid rgba(56,189,248,.15);
    border-radius: 14px;
    overflow:hidden;
  }
  .zt-table thead th{
    text-align:left;
    font-weight:600;
    padding: 12px 12px;
    background: rgba(2, 11, 26, .85);
    border-bottom: 1px solid rgba(56,189,248,.12);
    white-space: nowrap;
  }
  .zt-table tbody td{
    padding: 11px 12px;
    border-bottom: 1px solid rgba(148,163,184,.12);
    vertical-align: middle;
  }
  .zt-table tbody tr:hover{
    background: rgba(56,189,248,.06);
  }
  .muted{ color:#94a3b8; }

  /* modal */
  .modal-bg{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.62);
    display:none;
    justify-content:center;
    align-items:flex-start;
    padding: 80px 14px 20px;
    z-index: 1000;
  }
  .modal{
    width: min(980px, 96vw);
    background: #020b1a;
    border: 1px solid rgba(56,189,248,.18);
    border-radius: 16px;
    padding: 18px 18px 16px;
    box-shadow: 0 20px 60px rgba(0,0,0,.55);
  }
  .modal h2{
    margin: 6px 0 14px;
    color:#e5e7eb;
  }
  .grid-2{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px 14px;
  }
  .field label{
    display:block;
    font-size: 13px;
    color:#cbd5e1;
    margin-bottom: 6px;
  }
  .field input, .field select{
    width:100%;
    padding: 10px 10px;
    border-radius: 10px;
    border: 1px solid rgba(148,163,184,.25);
    background: rgba(2,6,23,.65);
    color:#e5e7eb;
    outline: none;
  }
  .field input[readonly]{
    opacity:.9;
  }
  .acoes{
    display:flex;
    justify-content:flex-end;
    gap:10px;
    margin-top: 14px;
  }

  @media (max-width: 820px){
    .grid-2{ grid-template-columns: 1fr; }
    .zt-title{ font-size: 24px; }
  }
</style>
</head>

<body>

<!-- HEADER (NÃO CORTA MAIS) -->
<header class="zt-header">
  <div class="row">
    <h1 class="zt-title">Zincagem / Tratamento</h1>
    <div class="zt-actions">
      <button class="btn-azul" id="btnVoltar">← Voltar ao menu</button>
      <button class="btn-azul" id="btnFiltros">Filtros</button>
      <button class="btn-verde" id="btnNovaOp">+ Nova OP</button>
    </div>
  </div>
</header>

<main class="zt-main">

  <!-- TABELA -->
  <table class="zt-table">
    <thead>
      <tr>
        <th>OP</th>
        <th>Data</th>
        <th>Peça</th>
        <th>Acab.</th>
        <th>Kg Líq.</th>
        <th>Qtd</th>
        <th>Kg Bruto</th>
        <th>R$/Kg</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="listaOps">
      <tr><td class="muted" colspan="9">Carregando…</td></tr>
    </tbody>
  </table>

</main>

<!-- MODAL NOVA OP -->
<div class="modal-bg" id="modalBg" aria-hidden="true">
  <div class="modal">
    <h2>Nova OP</h2>

    <div class="grid-2">

      <div class="field">
        <label>OP</label>
        <input id="op" />
      </div>

      <div class="field">
        <label>Data</label>
        <input type="date" id="data" />
      </div>

      <div class="field">
        <label>Peça</label>
        <select id="peca">
          <option value="">Carregando…</option>
        </select>
      </div>

      <div class="field">
        <label>Acabamento</label>
        <select id="acabamento">
          <option value="Zincado">Zincado</option>
          <option value="Tratado">Tratado</option>
        </select>
      </div>

      <div class="field">
        <label>Comprimento (mm)</label>
        <input id="comprimento" readonly />
      </div>

      <div class="field">
        <label>Pç / Caixa</label>
        <input id="pc_caixa" readonly />
      </div>

      <div class="field">
        <label>Peso Caixa</label>
        <input id="peso_caixa" readonly />
      </div>

      <div class="field">
        <label>Kg Líquido</label>
        <input id="kg_liquido" inputmode="decimal" placeholder="ex: 12,345" />
      </div>

      <div class="field">
        <label>Quantidade</label>
        <input id="quantidade" readonly />
      </div>

      <div class="field">
        <label>Kg Bruto</label>
        <input id="kg_bruto" readonly />
      </div>

      <div class="field">
        <label>R$/Kg</label>
        <input id="rs_kg" inputmode="decimal" placeholder="ex: 2,50" />
      </div>

      <div class="field">
        <label>Total</label>
        <input id="total" readonly />
      </div>

    </div>

    <div class="acoes">
      <button class="btn-verde" id="btnSalvar">Salvar</button>
      <button class="btn-vermelho" id="btnCancelar">Cancelar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* =========================================================
   COLE SUAS CHAVES AQUI (OBRIGATORIO)
========================================================= */
const SUPABASE_URL = "SUA_SUPABASE_URL";
const SUPABASE_ANON_KEY = "SUA_SUPABASE_ANON_KEY";

/* =========================================================
   SUPABASE CLIENT (CORRETO)
========================================================= */
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================================================
   HELPERS
========================================================= */
const $ = (id) => document.getElementById(id);

function n(v){
  return Number(String(v ?? "").replace(".", "").replace(",", ".")) || 0;
}
function f2(v){
  return (Number(v) || 0).toLocaleString("pt-BR",{minimumFractionDigits:2});
}
function f3(v){
  return (Number(v) || 0).toLocaleString("pt-BR",{minimumFractionDigits:3});
}
function dataBR(iso){
  if(!iso) return "";
  // iso pode vir "YYYY-MM-DD" ou timestamp
  const s = String(iso).slice(0,10);
  const [y,m,d] = s.split("-");
  if(!y || !m || !d) return s;
  return `${d}/${m}/${y}`;
}

/* =========================================================
   INIT
========================================================= */
document.addEventListener("DOMContentLoaded", () => {
  $("btnVoltar").onclick = () => location.href = "dashboard.html";

  $("btnNovaOp").onclick = async () => {
    abrirModal();
    await carregarProdutos(); // carrega sempre ao abrir
  };

  $("btnCancelar").onclick = fecharModal;

  // fechar clicando fora
  $("modalBg").addEventListener("click", (e) => {
    if(e.target === $("modalBg")) fecharModal();
  });

  $("btnSalvar").onclick = salvarOP;

  $("peca").addEventListener("change", onSelectPeca);
  $("kg_liquido").addEventListener("input", calcular);
  $("rs_kg").addEventListener("input", calcular);

  carregarOps();
});

/* =========================================================
   MODAL
========================================================= */
function abrirModal(){
  $("modalBg").style.display = "flex";
  $("modalBg").setAttribute("aria-hidden","false");
}
function fecharModal(){
  $("modalBg").style.display = "none";
  $("modalBg").setAttribute("aria-hidden","true");
}

/* =========================================================
   LISTAR OPS (zincagem_tratamento)
========================================================= */
async function carregarOps(){
  $("listaOps").innerHTML = `<tr><td class="muted" colspan="9">Carregando…</td></tr>`;

  const { data, error } = await supa
    .from("zincagem_tratamento")
    .select("op,data,codigo_peca_text,acabamento,kg_liquido,quantidade,kg_bruto,rs_kg,total,created_at")
    .order("created_at", { ascending: false });

  if(error){
    $("listaOps").innerHTML = `<tr><td class="muted" colspan="9">Erro ao carregar OPs: ${error.message}</td></tr>`;
    console.error(error);
    return;
  }

  if(!data || data.length === 0){
    $("listaOps").innerHTML = `<tr><td class="muted" colspan="9">Nenhuma OP cadastrada.</td></tr>`;
    return;
  }

  $("listaOps").innerHTML = data.map(r => `
    <tr>
      <td>${r.op ?? ""}</td>
      <td>${dataBR(r.data)}</td>
      <td>${r.codigo_peca_text ?? ""}</td>
      <td>${r.acabamento ?? ""}</td>
      <td>${f3(r.kg_liquido)}</td>
      <td>${r.quantidade ?? 0}</td>
      <td>${f3(r.kg_bruto)}</td>
      <td>${f2(r.rs_kg)}</td>
      <td>${f2(r.total)}</td>
    </tr>
  `).join("");
}

/* =========================================================
   CARREGAR PRODUTOS (produtos)
========================================================= */
async function carregarProdutos(){
  $("peca").innerHTML = `<option value="">Carregando…</option>`;

  const { data, error } = await supa
    .from("produtos")
    .select("id,codigo,descricao,comprimento_mm,quantidade_caixa,peso_caixa");

  if(error){
    $("peca").innerHTML = `<option value="">Erro ao carregar</option>`;
    alert("Erro ao carregar peças: " + error.message);
    console.error(error);
    return;
  }

  if(!data || data.length === 0){
    $("peca").innerHTML = `<option value="">Sem peças cadastradas</option>`;
    return;
  }

  // ordena no front (seguro)
  data.sort((a,b) => String(a.codigo).localeCompare(String(b.codigo)));

  $("peca").innerHTML = `<option value="">Selecione</option>` + data.map(p => {
    return `<option value="${p.id}"
      data-codigo="${p.codigo ?? ""}"
      data-comp="${p.comprimento_mm ?? 0}"
      data-pc="${p.quantidade_caixa ?? 0}"
      data-peso="${p.peso_caixa ?? 0}">
      ${p.codigo ?? ""} - ${p.descricao ?? ""}
    </option>`;
  }).join("");
}

function onSelectPeca(){
  const opt = $("peca").selectedOptions[0];
  if(!opt || !opt.dataset) return;

  $("comprimento").value = opt.dataset.comp ?? "";
  $("pc_caixa").value = opt.dataset.pc ?? "";
  $("peso_caixa").value = f3(n(opt.dataset.peso ?? 0));

  calcular();
}

/* =========================================================
   CALCULO
========================================================= */
function calcular(){
  const peso = n($("peso_caixa").value || 0);
  const kgliq = n($("kg_liquido").value || 0);
  const rskg = n($("rs_kg").value || 0);

  if(!peso || peso <= 0){
    $("quantidade").value = "";
    $("kg_bruto").value = "";
    $("total").value = "";
    return;
  }

  const qtd = Math.floor(kgliq / peso);
  const kgbr = qtd * peso;
  const tot = kgbr * rskg;

  $("quantidade").value = qtd;
  $("kg_bruto").value = f3(kgbr);
  $("total").value = f2(tot);
}

/* =========================================================
   SALVAR OP
========================================================= */
async function salvarOP(){
  const opt = $("peca").selectedOptions[0];
  if(!$("op").value.trim()){
    alert("Informe a OP.");
    return;
  }
  if(!$("data").value){
    alert("Informe a data.");
    return;
  }
  if(!$("peca").value){
    alert("Selecione a peça.");
    return;
  }

  const payload = {
    op: $("op").value.trim(),
    data: $("data").value, // ISO YYYY-MM-DD
    produto_id: $("peca").value,
    codigo_peca_text: opt?.dataset?.codigo ?? "",
    acabamento: $("acabamento").value,
    comprimento_mm: n($("comprimento").value),
    pecas_por_caixa: n($("pc_caixa").value),
    peso_caixa: n($("peso_caixa").value),
    kg_liquido: n($("kg_liquido").value),
    quantidade: n($("quantidade").value),
    kg_bruto: n($("kg_bruto").value),
    rs_kg: n($("rs_kg").value),
    total: n($("total").value)
  };

  const { error } = await supa
    .from("zincagem_tratamento")
    .insert(payload);

  if(error){
    alert("Erro ao salvar: " + error.message);
    console.error(error);
    return;
  }

  fecharModal();
  await carregarOps();
}
</script>

</body>
</html>
