import { supabase, verificarLogin } from "./auth.js";

document.addEventListener("DOMContentLoaded", async () => {
  const user = await verificarLogin();
  if (!user) return;

  btnLogout.onclick = async () => {
    await supabase.auth.signOut();
    location.href = "index.html";
  };

  btnNovaOp.onclick = () => {
    modalBg.style.display = "flex";
    carregarProdutos();
  };

  btnCancelar.onclick = () => modalBg.style.display = "none";
  btnSalvar.onclick = salvarOP;

  carregarOps();
});

/* ================= UTIL ================= */
const n = v => Number(String(v).replace(",", ".")) || 0;
const f2 = v => v.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
const f3 = v => v.toLocaleString("pt-BR", { minimumFractionDigits: 3 });

/* ================= LISTAR OPS ================= */
async function carregarOps(){
  const { data } = await supabase
    .from("zincagem_tratamento")
    .select("*")
    .order("created_at", { ascending:false });

  listaOps.innerHTML = "";

  data?.forEach(op => {
    listaOps.innerHTML += `
      <tr>
        <td>${op.op}</td>
        <td>${op.data}</td>
        <td>${op.codigo_peca_text}</td>
        <td>${op.acabamento}</td>
        <td>${op.kg_liquido}</td>
        <td>${op.quantidade}</td>
        <td>${op.kg_bruto}</td>
        <td>${op.rs_kg}</td>
        <td>${op.total}</td>
      </tr>`;
  });
}

/* ================= PRODUTOS ================= */
async function carregarProdutos(){
  const { data } = await supabase
    .from("produtos")
    .select("id,codigo,descricao,comprimento_mm,quantidade_caixa,peso_caixa");

  peca.innerHTML = `<option value="">Selecione</option>`;
  data?.forEach(p => {
    const o = document.createElement("option");
    o.value = p.id;
    o.textContent = `${p.codigo} - ${p.descricao}`;
    o.dataset.codigo = p.codigo;
    o.dataset.comp = p.comprimento_mm;
    o.dataset.pc = p.quantidade_caixa;
    o.dataset.peso = p.peso_caixa;
    peca.appendChild(o);
  });
}

peca.onchange = () => {
  const o = peca.selectedOptions[0];
  comprimento.value = o.dataset.comp;
  pc_caixa.value = o.dataset.pc;
  peso_caixa.value = f3(n(o.dataset.peso));
};

/* ================= CÃLCULO ================= */
kg_liquido.oninput = rs_kg.oninput = () => {
  const qtd = Math.floor(n(kg_liquido.value) / n(peso_caixa.value || 1));
  quantidade.value = qtd;
  kg_bruto.value = f3(qtd * n(peso_caixa.value));
  total.value = f2(n(rs_kg.value) * n(kg_bruto.value));
};

/* ================= SALVAR ================= */
async function salvarOP(){
  const o = peca.selectedOptions[0];

  await supabase.from("zincagem_tratamento").insert({
    op: op.value,
    data: data.value,
    produto_id: peca.value,
    codigo_peca_text: o.dataset.codigo,
    acabamento: acabamento.value,
    comprimento_mm: n(comprimento.value),
    pecas_por_caixa: n(pc_caixa.value),
    peso_caixa: n(peso_caixa.value),
    kg_liquido: n(kg_liquido.value),
    quantidade: n(quantidade.value),
    kg_bruto: n(kg_bruto.value),
    rs_kg: n(rs_kg.value),
    total: n(total.value)
  });

  modalBg.style.display = "none";
  carregarOps();
}
