<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Zincagem / Tratamento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SUPABASE CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;font-family:Segoe UI,Arial}
body{
  margin:0;
  background:radial-gradient(circle at top,#0b1224,#020617 70%);
  color:#e5e7eb;
}
header{
  padding:20px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
h1{margin:0;color:#38bdf8}
button{
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
}
.btn-azul{background:#38bdf8;color:#000}
.btn-branco{background:#fff;color:#000}
.container{padding:0 30px 30px}

table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #1e293b}
th{color:#38bdf8;text-align:left}

.modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.modal{
  width:1000px;
  background:linear-gradient(180deg,#020b1a,#020617);
  border-radius:16px;
  padding:24px;
}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
.campo{display:flex;flex-direction:column}
.campo label{font-size:13px;margin-bottom:4px;color:#cbd5f5}
input,select{
  padding:10px;
  border-radius:8px;
  border:1px solid #1e293b;
  background:#020617;
  color:#e5e7eb;
}
input[readonly]{background:#020b1a;color:#9ca3af}
.footer{
  margin-top:20px;
  display:flex;
  justify-content:flex-end;
  gap:10px;
}
</style>
</head>

<body>

<header>
  <h1>Zincagem / Tratamento</h1>
  <div>
    <button class="btn-branco" onclick="location.href='menu.html'">← Voltar ao menu</button>
    <button class="btn-azul" onclick="abrirModal()">+ Nova OP</button>
  </div>
</header>

<div class="container">
<table>
<thead>
<tr>
  <th>OP</th>
  <th>Data</th>
  <th>Peça</th>
  <th>Acab.</th>
  <th>Kg</th>
  <th>Qtd</th>
  <th>Kg Bruto</th>
  <th>R$/Kg</th>
  <th>Total</th>
</tr>
</thead>
<tbody id="lista">
<tr><td colspan="9">Carregando...</td></tr>
</tbody>
</table>
</div>

<!-- MODAL -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h2>Nova OP</h2>

    <div class="grid">
      <div class="campo">
        <label>OP</label>
        <input id="op">
      </div>

      <div class="campo">
        <label>Data</label>
        <input type="date" id="data">
      </div>

      <div class="campo">
        <label>Peça</label>
        <select id="produto_id"></select>
      </div>

      <div class="campo">
        <label>Acabamento</label>
        <input id="acabamento" placeholder="Zincado / Tratado">
      </div>

      <div class="campo">
        <label>Kg</label>
        <input id="kg" inputmode="decimal" placeholder="0,00">
      </div>

      <div class="campo">
        <label>Quantidade</label>
        <input id="quantidade" readonly>
      </div>

      <div class="campo">
        <label>Kg Bruto</label>
        <input id="kg_bruto" readonly>
      </div>

      <div class="campo">
        <label>R$/Kg</label>
        <input id="preco_kg" inputmode="decimal" placeholder="0,00">
      </div>

      <div class="campo" style="grid-column:1/3">
        <label>Total</label>
        <input id="valor_total" readonly>
      </div>
    </div>

    <div class="footer">
      <button class="btn-branco" onclick="fecharModal()">Cancelar</button>
      <button class="btn-azul" onclick="salvar()">Salvar</button>
    </div>
  </div>
</div>

<script>
(() => {
  // ===============================
  //  SUPABASE CLIENT (SEM CONFLITO)
  //  - nunca usa "const supabase"
  //  - guarda em window.__sbClient
  // ===============================
  const SUPABASE_URL = "https://uxtgicfuggpuyjybwawa.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4dGdpY2Z1Z2dwdXlqeWJ3YXdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNjIyNjIsImV4cCI6MjA3ODgzODI2Mn0.bYAyuTccwk21yWiYrFt_v6mWubDWJGVRWT0rJT74fGg";

  if (!window.__sbClient) {
    window.__sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }
  const sb = window.__sbClient;

  // ===============================
  //  ELEMENTOS
  // ===============================
  const modalBg = document.getElementById("modalBg");
  const lista = document.getElementById("lista");

  const el = (id) => document.getElementById(id);

  // ===============================
  //  PRODUTO SELECIONADO (pesos)
  // ===============================
  let pesoUnit = 0;       // peso unitario (liquido)
  let pesoBrutoUnit = 0;  // peso bruto unitario

  function parseBR(v) {
    if (v === null || v === undefined) return 0;
    const s = String(v).trim().replace(/\./g, "").replace(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function format2(n) {
    const x = Number(n);
    return Number.isFinite(x) ? x.toFixed(2) : "0.00";
  }

  // ===============================
  //  MODAL
  // ===============================
  async function abrirModal() {
    modalBg.style.display = "flex";

    // data default hoje (BR)
    if (!el("data").value) {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      el("data").value = `${yyyy}-${mm}-${dd}`;
    }

    await carregarProdutos();
    calcular(); // recalcula se já tiver valores
  }

  function fecharModal() {
    modalBg.style.display = "none";
  }

  // expor para onclick
  window.abrirModal = abrirModal;
  window.fecharModal = fecharModal;

  // ===============================
  //  CARREGAR PRODUTOS
  //  (aceita peso_unitario OU peso_liquido)
  // ===============================
  async function carregarProdutos() {
    const sel = el("produto_id");

    const { data, error } = await sb
      .from("produtos")
      .select("id, descricao, codigo, peso_unitario, peso_liquido, peso_bruto");

    if (error) {
      alert("Erro produtos: " + error.message);
      sel.innerHTML = "<option value=''>Erro ao carregar</option>";
      return;
    }

    sel.innerHTML = "<option value=''>Selecione</option>";

    (data || []).forEach(p => {
      const o = document.createElement("option");
      o.value = p.id;
      o.textContent = p.descricao || p.codigo || ("ID " + p.id);

      // prioridade: peso_unitario, senão peso_liquido
      const pu = (p.peso_unitario ?? p.peso_liquido ?? 0);
      const pb = (p.peso_bruto ?? 0);

      o.dataset.pu = pu;
      o.dataset.pb = pb;
      sel.appendChild(o);
    });

    sel.onchange = () => {
      const opt = sel.selectedOptions[0];
      if (!opt || !opt.value) {
        pesoUnit = 0;
        pesoBrutoUnit = 0;
        calcular();
        return;
      }
      pesoUnit = Number(opt.dataset.pu) || 0;
      pesoBrutoUnit = Number(opt.dataset.pb) || 0;
      calcular();
    };
  }

  // ===============================
  //  CÁLCULOS AUTOMÁTICOS
  //  Quantidade = floor(kg / pesoUnit)
  //  Kg Bruto   = quantidade * pesoBrutoUnit
  //  Total      = kg * preco_kg
  // ===============================
  function calcular() {
    const kg = parseBR(el("kg").value);
    const precoKg = parseBR(el("preco_kg").value);

    // quantidade / kg_bruto só se tiver peso unit
    let qtd = 0;
    if (pesoUnit > 0 && kg > 0) {
      qtd = Math.floor(kg / pesoUnit);
    }

    el("quantidade").value = qtd ? String(qtd) : "";
    el("kg_bruto").value = (qtd && pesoBrutoUnit) ? format2(qtd * pesoBrutoUnit) : (qtd ? format2(qtd * (pesoBrutoUnit || 0)) : "");

    el("valor_total").value = (kg && precoKg) ? format2(kg * precoKg) : (kg && precoKg === 0 ? format2(0) : "");
  }

  el("kg").addEventListener("input", calcular);
  el("preco_kg").addEventListener("input", calcular);

  // ===============================
  //  SALVAR (NOMES IGUAIS À TABELA)
  //  zincagem_tratamento:
  //   op, data, produto_id, acabamento,
  //   kg, quantidade, kg_bruto, preco_kg, valor_total
  // ===============================
  async function salvar() {
    const payload = {
      op: el("op").value,
      data: el("data").value,
      produto_id: el("produto_id").value || null,
      acabamento: el("acabamento").value,
      kg: parseBR(el("kg").value),
      quantidade: Number(el("quantidade").value || 0),
      kg_bruto: parseBR(el("kg_bruto").value),
      preco_kg: parseBR(el("preco_kg").value),
      valor_total: parseBR(el("valor_total").value)
    };

    const { error } = await sb.from("zincagem_tratamento").insert(payload);

    if (error) {
      alert("Erro ao salvar: " + error.message);
      return;
    }

    location.reload();
  }

  window.salvar = salvar;

  // ===============================
  //  LISTAGEM (JOIN produtos.descricao)
  // ===============================
  async function carregarLista() {
    const { data, error } = await sb
      .from("zincagem_tratamento")
      .select(`
        op,
        data,
        acabamento,
        kg,
        quantidade,
        kg_bruto,
        preco_kg,
        valor_total,
        produtos ( descricao )
      `)
      .order("data", { ascending: false });

    if (error) {
      lista.innerHTML = `<tr><td colspan="9">Erro ao carregar: ${error.message}</td></tr>`;
      return;
    }

    lista.innerHTML = "";

    (data || []).forEach(r => {
      lista.innerHTML += `
        <tr>
          <td>${r.op ?? ""}</td>
          <td>${r.data ?? ""}</td>
          <td>${(r.produtos && r.produtos.descricao) ? r.produtos.descricao : "-"}</td>
          <td>${r.acabamento ?? ""}</td>
          <td>${r.kg ?? ""}</td>
          <td>${r.quantidade ?? ""}</td>
          <td>${r.kg_bruto ?? ""}</td>
          <td>${r.preco_kg ?? ""}</td>
          <td>${r.valor_total ?? ""}</td>
        </tr>
      `;
    });

    if ((data || []).length === 0) {
      lista.innerHTML = `<tr><td colspan="9">Sem registros</td></tr>`;
    }
  }

  carregarLista();
})();
</script>

</body>
</html>
