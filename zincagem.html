<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Zincagem / Tratamento</title>

<link rel="stylesheet" href="css/dashboard.css" />

<style>
html, body {
  height: 100%;
  margin: 0;
  background: radial-gradient(circle at top, #0b1224, #020617 70%);
  color: #e5e7eb;
  overflow-x: hidden;
}

/* HEADER */
.zt-header{
  position: sticky;
  top: 0;
  z-index: 50;
  background: rgba(2, 6, 23, .95);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid rgba(56, 189, 248, .15);
  padding: 18px 22px;
}
.zt-header .row{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
}
.zt-title{
  margin:0;
  font-size:28px;
  color:#38bdf8;
}
.zt-actions{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

/* MAIN */
.zt-main{
  padding:18px 22px 28px;
}

/* TABLE */
.zt-table{
  width:100%;
  border-collapse:collapse;
  background:rgba(2,11,26,.55);
  border:1px solid rgba(56,189,248,.15);
  border-radius:14px;
  overflow:hidden;
}
.zt-table thead th{
  padding:12px;
  background:rgba(2,11,26,.85);
  border-bottom:1px solid rgba(56,189,248,.12);
  text-align:left;
}
.zt-table tbody td{
  padding:11px 12px;
  border-bottom:1px solid rgba(148,163,184,.12);
}
.zt-table tbody tr:hover{
  background:rgba(56,189,248,.06);
}
.muted{ color:#94a3b8; }

/* MODAL */
.modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.62);
  display:none;
  justify-content:center;
  align-items:flex-start;
  padding:80px 14px 20px;
  z-index:1000;
}
.modal{
  background:#020b1a;
  border-radius:16px;
  border:1px solid rgba(56,189,248,.18);
  padding:18px;
  width:min(980px,96vw);
}
.grid-2{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:14px;
}
.field label{
  display:block;
  font-size:13px;
  margin-bottom:6px;
}
.field input,
.field select{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid rgba(148,163,184,.25);
  background:rgba(2,6,23,.65);
  color:#e5e7eb;
}
.field input[readonly]{ opacity:.9; }
.acoes{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:16px;
}

@media(max-width:820px){
  .grid-2{ grid-template-columns:1fr; }
  .zt-title{ font-size:24px; }
}
</style>
</head>

<body>

<header class="zt-header">
  <div class="row">
    <h1 class="zt-title">Zincagem / Tratamento</h1>
    <div class="zt-actions">
      <button class="btn-azul" onclick="location.href='dashboard.html'">← Voltar ao menu</button>
      <button class="btn-azul" disabled>Filtros</button>
      <button class="btn-verde" id="btnNovaOp">+ Nova OP</button>
    </div>
  </div>
</header>

<main class="zt-main">
  <table class="zt-table">
    <thead>
      <tr>
        <th>OP</th>
        <th>Data</th>
        <th>Peça</th>
        <th>Acab.</th>
        <th>Kg Líq.</th>
        <th>Qtd</th>
        <th>Kg Bruto</th>
        <th>R$/Kg</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody id="listaOps">
      <tr><td class="muted" colspan="9">Carregando…</td></tr>
    </tbody>
  </table>
</main>

<!-- MODAL -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h2>Nova OP</h2>

    <div class="grid-2">
      <div class="field"><label>OP</label><input id="op"></div>
      <div class="field"><label>Data</label><input type="date" id="data"></div>

      <div class="field"><label>Peça</label><select id="peca"></select></div>
      <div class="field"><label>Acabamento</label>
        <select id="acabamento">
          <option>Zincado</option>
          <option>Tratado</option>
        </select>
      </div>

      <div class="field"><label>Comprimento (mm)</label><input id="comprimento" readonly></div>
      <div class="field"><label>Pç / Caixa</label><input id="pc_caixa" readonly></div>

      <div class="field"><label>Peso Caixa</label><input id="peso_caixa" readonly></div>
      <div class="field"><label>Kg Líquido</label><input id="kg_liquido"></div>

      <div class="field"><label>Quantidade</label><input id="quantidade" readonly></div>
      <div class="field"><label>Kg Bruto</label><input id="kg_bruto" readonly></div>

      <div class="field"><label>R$/Kg</label><input id="rs_kg"></div>
      <div class="field"><label>Total</label><input id="total" readonly></div>
    </div>

    <div class="acoes">
      <button class="btn-verde" id="btnSalvar">Salvar</button>
      <button class="btn-vermelho" onclick="fecharModal()">Cancelar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===== SUPABASE (CHAVES INSERIDAS) ===== */
const supabase = window.supabase.createClient(
  "https://uxtgicfuggpuyjybwawa.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4dGdpY2Z1Z2dwdXlqeWJ3YXdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNjIyNjIsImV4cCI6MjA3ODgzODI2Mn0.bYAyuTccwk21yWiYrFt_v6mWubDWJGVRWT0rJT74fGg"
);

/* HELPERS */
const $ = id => document.getElementById(id);
const n = v => Number(String(v||"").replace(",", ".")) || 0;
const f2 = v => (Number(v)||0).toLocaleString("pt-BR",{minimumFractionDigits:2});
const f3 = v => (Number(v)||0).toLocaleString("pt-BR",{minimumFractionDigits:3});
const dataBR = iso => iso ? iso.split("-").reverse().join("/") : "";

/* INIT */
document.addEventListener("DOMContentLoaded", () => {
  $("btnNovaOp").onclick = abrirModal;
  $("kg_liquido").oninput = calcular;
  $("rs_kg").oninput = calcular;
  $("peca").onchange = preencher;
  $("btnSalvar").onclick = salvarOP;
  carregarOps();
});

/* MODAL */
function abrirModal(){
  $("modalBg").style.display="flex";
  carregarProdutos();
}
function fecharModal(){
  $("modalBg").style.display="none";
}

/* OPS */
async function carregarOps(){
  const { data } = await supabase
    .from("zincagem_tratamento")
    .select("*")
    .order("created_at",{ascending:false});

  $("listaOps").innerHTML = data?.length ? data.map(o=>`
    <tr>
      <td>${o.op}</td>
      <td>${dataBR(o.data)}</td>
      <td>${o.codigo_peca_text}</td>
      <td>${o.acabamento}</td>
      <td>${f3(o.kg_liquido)}</td>
      <td>${o.quantidade}</td>
      <td>${f3(o.kg_bruto)}</td>
      <td>${f2(o.rs_kg)}</td>
      <td>${f2(o.total)}</td>
    </tr>`).join("") :
    `<tr><td class="muted" colspan="9">Nenhuma OP cadastrada.</td></tr>`;
}

/* PRODUTOS */
async function carregarProdutos(){
  const { data, error } = await supabase
    .from("produtos")
    .select("id,codigo,descricao,comprimento_mm,quantidade_caixa,peso_caixa");

  if(error){ alert(error.message); return; }

  $("peca").innerHTML = `<option value="">Selecione</option>` + data.map(p=>`
    <option value="${p.id}"
      data-codigo="${p.codigo}"
      data-comp="${p.comprimento_mm}"
      data-pc="${p.quantidade_caixa}"
      data-peso="${p.peso_caixa}">
      ${p.codigo} - ${p.descricao}
    </option>`).join("");
}

function preencher(){
  const o=$("peca").selectedOptions[0];
  $("comprimento").value=o.dataset.comp;
  $("pc_caixa").value=o.dataset.pc;
  $("peso_caixa").value=f3(n(o.dataset.peso));
  calcular();
}

/* CALC */
function calcular(){
  const peso=n($("peso_caixa").value);
  const kg=n($("kg_liquido").value);
  const rskg=n($("rs_kg").value);
  if(!peso) return;
  const qtd=Math.floor(kg/peso);
  $("quantidade").value=qtd;
  $("kg_bruto").value=f3(qtd*peso);
  $("total").value=f2(qtd*peso*rskg);
}

/* SALVAR */
async function salvarOP(){
  const o=$("peca").selectedOptions[0];
  await supabase.from("zincagem_tratamento").insert({
    op:$("op").value,
    data:$("data").value,
    produto_id:$("peca").value,
    codigo_peca_text:o.dataset.codigo,
    acabamento:$("acabamento").value,
    comprimento_mm:n($("comprimento").value),
    pecas_por_caixa:n($("pc_caixa").value),
    peso_caixa:n($("peso_caixa").value),
    kg_liquido:n($("kg_liquido").value),
    quantidade:n($("quantidade").value),
    kg_bruto:n($("kg_bruto").value),
    rs_kg:n($("rs_kg").value),
    total:n($("total").value)
  });
  fecharModal();
  carregarOps();
}
</script>

</body>
</html>
