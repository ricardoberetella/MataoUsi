<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Zincagem / Tratamento</title>

<link rel="stylesheet" href="css/dashboard.css">

<style>
.form-zincagem{
  max-width:900px;
  margin:auto;
  background:rgba(0,0,0,.5);
  padding:24px;
  border-radius:16px;
}
.form-grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:16px;
}
label{
  font-size:13px;
  opacity:.8;
}
input,select{
  width:100%;
  padding:10px;
  background:#020617;
  border:1px solid #38bdf8;
  color:#e5e7eb;
  border-radius:8px;
}
input[readonly]{
  background:#020b1a;
  color:#7dd3fc;
}
.botao{
  padding:12px;
  background:#22c55e;
  border:none;
  color:#022c22;
  font-weight:bold;
  border-radius:10px;
  cursor:pointer;
}
.botao:hover{opacity:.9}
</style>

</head>
<body>

<div class="layout">

  <aside class="sidebar">
    <div class="logo-sistema">MATÃO USINAGEM</div>
    <nav class="menu">
      <a href="dashboard.html" class="menu-item">⬅ Voltar</a>
    </nav>
  </aside>

  <main class="main">
    <h1 style="color:#38bdf8;margin-bottom:20px">Zincagem / Tratamento Térmico</h1>

    <div class="form-zincagem">
      <div class="form-grid">

        <div>
          <label>OP</label>
          <input id="op">
        </div>

        <div>
          <label>Data</label>
          <input type="date" id="data">
        </div>

        <div>
          <label>Produto</label>
          <select id="produtoSelect"></select>
        </div>

        <div>
          <label>Comprimento</label>
          <input id="comp" readonly>
        </div>

        <div>
          <label>Serviço</label>
          <input id="servico" readonly>
        </div>

        <div>
          <label>Peças por Caixa</label>
          <input id="ppc" readonly>
        </div>

        <div>
          <label>Kg</label>
          <input id="kg" type="number" step="0.01">
        </div>

        <div>
          <label>Quantidade</label>
          <input id="quantidade" readonly>
        </div>

        <div>
          <label>Kg Material Bruto</label>
          <input id="kgBruto" readonly>
        </div>

        <div>
          <label>Entregue</label>
          <select id="entregue">
            <option value="false"></option>
            <option value="true">OK</option>
          </select>
        </div>

        <div>
          <label>Boleto</label>
          <select id="boleto">
            <option value="false"></option>
            <option value="true">OK</option>
          </select>
        </div>

      </div>

      <br>
      <button class="botao" id="btnSalvar">Salvar</button>

    </div>

  </main>
</div>

<script type="module">
  import { supabase, verificarLogin } from "./js/auth.js";

  let produtos = [];
  let produtoSelecionado = null;

  document.addEventListener("DOMContentLoaded", async () => {
    const user = await verificarLogin();
    if (!user) return;

    await carregarProdutos();
    configurarEventos();
  });

  async function carregarProdutos(){
    const { data, error } = await supabase
      .from("produtos")
      .select("id, codigo, comprimento, acabamento, peso_liquido, peso_bruto, pecas_por_caixa, usar_em_acabamento")
      .order("codigo");

    if(error){
      alert("Erro ao carregar produtos");
      console.error(error);
      return;
    }

    produtos = data.filter(p => p.usar_em_acabamento === true);

    const select = document.getElementById("produtoSelect");
    select.innerHTML = `<option value="">Selecione</option>`;

    produtos.forEach(p=>{
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.codigo;
      select.appendChild(opt);
    });
  }

  function configurarEventos(){
    document.getElementById("produtoSelect").addEventListener("change", e=>{
      produtoSelecionado = produtos.find(p=>p.id == e.target.value);
      if(!produtoSelecionado) return;

      document.getElementById("comp").value = produtoSelecionado.comprimento || "";
      document.getElementById("servico").value = produtoSelecionado.acabamento || "";
      document.getElementById("ppc").value = produtoSelecionado.pecas_por_caixa || "";

      recalcular();
    });

    document.getElementById("kg").addEventListener("input", recalcular);
    document.getElementById("btnSalvar").addEventListener("click", salvar);
  }

  function recalcular(){
    if(!produtoSelecionado) return;
    const kg = parseFloat(document.getElementById("kg").value || 0);
    const quantidade = kg / (produtoSelecionado.peso_liquido || 1);
    const kgBruto = quantidade * (produtoSelecionado.peso_bruto || 0);
    document.getElementById("quantidade").value = quantidade.toFixed(0);
    document.getElementById("kgBruto").value = kgBruto.toFixed(2);
  }

  async function salvar(){
    if(!produtoSelecionado){
      alert("Selecione o produto");
      return;
    }

    const payload = {
      op: document.getElementById("op").value,
      data: document.getElementById("data").value,
      produto_id: produtoSelecionado.id,
      codigo_peca: produtoSelecionado.codigo,
      comp: produtoSelecionado.comprimento,
      pecas_por_caixa: produtoSelecionado.pecas_por_caixa,
      servico: produtoSelecionado.acabamento,
      kg: parseFloat(document.getElementById("kg").value),
      quantidade: parseFloat(document.getElementById("quantidade").value),
      kg_material_bruto: parseFloat(document.getElementById("kgBruto").value),
      peso_caixa: produtoSelecionado.peso_bruto,
      entregue: document.getElementById("entregue").value === "true",
      boleto: document.getElementById("boleto").value === "true"
    };

    const { error } = await supabase.from("zincagem_tratamento").insert(payload);

    if(error){
      alert("Erro ao salvar");
      console.error(error);
    } else {
      alert("Registro salvo");
      window.location.reload();
    }
  }
</script>

</body>
</html>
