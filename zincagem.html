<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Zincagem / Tratamento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="css/dashboard.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header>
  <button class="btn-azul" onclick="history.back()">← Voltar</button>
  <h1>Zincagem / Tratamento</h1>
  <button class="btn-verde" onclick="abrirModal()">+ Nova OP</button>
</header>

<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h2>Nova OP</h2>

    <div class="grid">
      <div><label>OP</label><input id="op"></div>
      <div><label>Data</label><input type="date" id="data"></div>

      <div>
        <label>Pino de Engate</label>
        <select id="peca"></select>
      </div>

      <div><label>Kg Líquido</label><input id="kg_liquido"></div>
      <div><label>Comprimento</label><input id="comprimento" readonly></div>
      <div><label>Pç / Caixa</label><input id="pc_caixa" readonly></div>

      <div>
        <label>Acabamento</label>
        <select id="acabamento">
          <option>Zincado</option>
          <option>Tratado</option>
        </select>
      </div>

      <div><label>Peso Caixa</label><input id="peso_caixa" readonly></div>
      <div><label>Quantidade</label><input id="quantidade" readonly></div>
      <div><label>Kg Bruto</label><input id="kg_bruto" readonly></div>
      <div><label>R$/Kg</label><input id="rs_kg"></div>
      <div><label>Total</label><input id="total" readonly></div>
    </div>

    <div class="actions">
      <button class="btn-verde" onclick="salvar()">Salvar</button>
      <button class="btn-vermelho" onclick="fecharModal()">Cancelar</button>
    </div>
  </div>
</div>

<script type="module">
import { supabase, verificarLogin } from "./js/auth.js";

/* =============================
   INIT
============================= */
document.addEventListener("DOMContentLoaded", async () => {
  const user = await verificarLogin();
  if (!user) return;
  carregarPinos();
});

/* =============================
   MODAL
============================= */
window.abrirModal = () => modalBg.style.display = "flex";
window.fecharModal = () => modalBg.style.display = "none";

/* =============================
   FORMATADORES
============================= */
const n = v => Number(String(v).replace(",", ".")) || 0;
const f = v => v.toLocaleString("pt-BR", { minimumFractionDigits: 2 });

/* =============================
   CARREGAR PINOS
============================= */
async function carregarPinos() {
  peca.innerHTML = `<option value="">Selecione</option>`;

  const { data, error } = await supabase
    .from("produtos")
    .select("codigo,descricao,comprimento,pc_caixa,peso_caixa")
    .ilike("descricao", "%pino%")
    .order("codigo");

  if (error) {
    console.error(error);
    alert("Erro ao carregar pinos");
    return;
  }

  data.forEach(p => {
    const o = document.createElement("option");
    o.value = p.codigo;
    o.textContent = `${p.codigo} – ${p.descricao}`;
    o.dataset.comp = p.comprimento;
    o.dataset.pc = p.pc_caixa;
    o.dataset.peso = p.peso_caixa;
    peca.appendChild(o);
  });
}

/* =============================
   AO SELECIONAR PINO
============================= */
peca.addEventListener("change", e => {
  const o = e.target.selectedOptions[0];
  if (!o) return;

  comprimento.value = o.dataset.comp || 0;
  pc_caixa.value = o.dataset.pc || 0;
  peso_caixa.value = f(n(o.dataset.peso));
  calcular();
});

/* =============================
   CÁLCULOS
============================= */
["kg_liquido", "rs_kg"].forEach(id =>
  document.getElementById(id).addEventListener("input", calcular)
);

function calcular() {
  const kgL = n(kg_liquido.value);
  const peso = n(peso_caixa.value);
  const rs = n(rs_kg.value);

  quantidade.value = peso ? Math.floor(kgL / peso) : 0;
  kg_bruto.value = f(kgL);
  total.value = f(kgL * rs);
}

/* =============================
   SALVAR
============================= */
async function salvar() {
  const payload = {
    op: op.value,
    data: data.value,
    peca: peca.value,
    acabamento: acabamento.value,
    kg_liquido: n(kg_liquido.value),
    peso_caixa: n(peso_caixa.value),
    quantidade: Number(quantidade.value),
    kg_bruto: n(kg_bruto.value),
    rs_kg: n(rs_kg.value),
    total: n(total.value)
  };

  const { error } = await supabase
    .from("zincagem_tratamento")
    .insert(payload);

  if (error) {
    console.error(error);
    alert("Erro ao salvar");
    return;
  }

  alert("OP salva com sucesso");
  fecharModal();
}
</script>

</body>
</html>
