<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Zincagem / Tratamento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/dashboard.css">

<style>
.tabela{width:100%;border-collapse:collapse;margin-top:20px;}
th,td{padding:8px;border-bottom:1px solid rgba(56,189,248,.3);text-align:center;}
th{color:#38bdf8;}
input,select{padding:8px;border-radius:6px;background:#020617;border:1px solid #38bdf8;color:#e5e7eb;width:100%;}
input[readonly]{background:#020b1a;color:#7dd3fc;}
</style>
</head>

<body>
<div class="layout">

<aside class="sidebar">
<div class="logo-sistema">MATÃO USINAGEM</div>
<nav class="menu"><a href="dashboard.html" class="menu-item">⬅ Voltar</a></nav>
</aside>

<main class="main">
<h1 style="color:#38bdf8">Zincagem / Tratamento</h1>

<div class="form-zincagem">
<div class="form-grid">

<input id="op" placeholder="OP">
<input type="date" id="data">

<select id="produtoSelect"></select>
<input id="codigo" readonly placeholder="Código">
<input id="comp" readonly placeholder="Comprimento">
<input id="ppc" readonly placeholder="Peças/Caixa">
<input id="servico" readonly placeholder="Serviço">

<input id="kg" placeholder="Kg">
<input id="kgBruto" readonly placeholder="Kg Material Bruto">
<input id="pesoCaixa" readonly placeholder="Peso Caixa">
<input id="quantidade" readonly placeholder="Quantidade">

<select id="entregue"><option value="false">Pendente</option><option value="true">OK</option></select>
<select id="boleto"><option value="false">Pendente</option><option value="true">OK</option></select>

</div>
<button class="botao" id="salvar">Salvar</button>
</div>

<input id="filtroOP" placeholder="Filtrar OP" style="margin-top:20px">

<table class="tabela">
<thead>
<tr>
<th>OP</th><th>Data</th><th>Peça</th><th>Comp</th><th>Pç/Caixa</th><th>Serviço</th>
<th>Kg</th><th>Bruto</th><th>Peso Caixa</th><th>Qtd</th><th>Entregue</th><th>Boleto</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>

</main>
</div>

<script type="module">
import { supabase } from "./js/auth.js";

let produtos=[], registros=[], produto=null;

window.onload=async()=>{
 const {data:{session}}=await supabase.auth.getSession();
 if(!session){location.href="login.html";return;}

 const {data}=await supabase.from("produtos")
 .select("id,codigo,comprimento_mm,acabamento,peso_liquido,peso_bruto,pecas_por_caixa")
 .eq("usar_em_acabamento",true);
 produtos=data;
 produtoSelect.innerHTML='<option value="">Selecione</option>';
 data.forEach(p=>produtoSelect.innerHTML+=`<option value="${p.id}">${p.codigo}</option>`);

 produtoSelect.onchange=()=>{produto=produtos.find(p=>p.id==produtoSelect.value);carregarProduto();}
 kg.oninput=calcular;
 salvar.onclick=salvarRegistro;
 filtroOP.oninput=render;

 carregarLista();
}

function carregarProduto(){
 if(!produto)return;
 codigo.value=produto.codigo;
 comp.value=produto.comprimento_mm;
 ppc.value=produto.pecas_por_caixa;
 servico.value=produto.acabamento;
 pesoCaixa.value=produto.peso_bruto;
 calcular();
}

function calcular(){
 if(!produto)return;
 const kgv=parseFloat(kg.value||0);
 const qtd=kgv/(produto.peso_liquido||1);
 quantidade.value=qtd.toFixed(0);
 kgBruto.value=(qtd*(produto.peso_bruto||0)).toFixed(2);
}

async function salvarRegistro(){
 if(!produto||!data.value)return alert("Informe data e produto");
 const payload={
  op:op.value,data:data.value,produto_id:produto.id,codigo_peca:produto.codigo,
  kg:+kg.value,quantidade:+quantidade.value,kg_material_bruto:+kgBruto.value,
  peso_caixa:+pesoCaixa.value,entregue:entregue.value==="true",boleto:boleto.value==="true"
 };
 const {error}=await supabase.from("zincagem_tratamento").insert(payload);
 if(error){alert("Erro");console.error(error);} else{op.value="";kg.value="";await carregarLista();}
}

async function carregarLista(){
 const {data}=await supabase.from("zincagem_tratamento").select("*").order("data",{ascending:false});
 registros=data;
 render();
}

function render(){
 const f=filtroOP.value;
 lista.innerHTML="";
 registros.filter(r=>!f||String(r.op).includes(f)).forEach(r=>{
  lista.innerHTML+=`<tr>
   <td>${r.op}</td><td>${r.data}</td><td>${r.codigo_peca}</td>
   <td>${r.comp||""}</td><td>${r.pecas_por_caixa||""}</td><td>${r.servico||""}</td>
   <td>${r.kg}</td><td>${r.kg_material_bruto}</td><td>${r.peso_caixa}</td>
   <td>${r.quantidade}</td><td>${r.entregue?"OK":"Pendente"}</td><td>${r.boleto?"OK":"Pendente"}</td>
  </tr>`;
 });
}
</script>

</body>
</html>
