<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Zincagem / Tratamento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="css/dashboard.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
.form-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:14px;
}
input,select,button{
  width:100%;
  padding:10px;
  background:#020617;
  border:1px solid #38bdf8;
  color:#e5e7eb;
  border-radius:8px;
}
input[readonly]{background:#020b1a;color:#7dd3fc}
.botao-salvar{background:#22c55e;color:#022c22;font-weight:bold}
.tabela{margin-top:20px}
.tabela table{width:100%;border-collapse:collapse}
.tabela th,.tabela td{padding:10px;border-bottom:1px solid #1e293b}
.btn-status{padding:6px 10px;border-radius:6px;border:none;cursor:pointer}
.btn-ok{background:#22c55e;color:#022c22}
.btn-pendente{background:#ef4444;color:#fff}
</style>
</head>

<body>
<div class="layout">

<aside class="sidebar">
  <div class="logo-sistema">MATÃO USINAGEM</div>
  <nav class="menu">
    <a href="dashboard.html" class="menu-item">⬅ Voltar</a>
  </nav>
</aside>

<main class="main">
<h1 style="color:#38bdf8">Zincagem / Tratamento</h1>

<div class="form-grid">
  <input id="op" placeholder="OP">
  <input type="date" id="data">
  <select id="produto"></select>
  <input id="comprimento" placeholder="Comprimento" readonly>

  <input id="pecas_caixa" placeholder="Peças por Caixa" readonly>
  <input id="acabamento" placeholder="Acabamento" readonly>
  <input id="peso_caixa" placeholder="Peso da Caixa (kg)" readonly>
  <input id="kg" placeholder="Kg">

  <input id="quantidade" placeholder="Quantidade" readonly>
  <input id="kg_bruto" placeholder="Kg Material Bruto" readonly>
  <button class="botao-salvar" onclick="salvar()">Salvar</button>
</div>

<input id="filtroOp" placeholder="Filtrar OP" style="margin-top:15px">

<div class="tabela">
<table>
<thead>
<tr>
<th>OP</th><th>Data</th><th>Peça</th><th>Comp</th><th>Pç/Cx</th>
<th>Acab.</th><th>Kg</th><th>Bruto</th><th>Peso Caixa</th>
<th>Qtd</th><th>Entregue</th><th>Boleto</th>
</tr>
</thead>
<tbody id="lista"></tbody>
</table>
</div>

</main>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./js/config.js";

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let produtos=[]; let produtoSel=null;

async function carregarProdutos(){
  const {data}=await supabase.from("produtos")
    .select("id,codigo,comprimento_mm,pecas_por_caixa,acabamento,peso_liquido")
    .order("codigo");

  produtos=data;
  const sel=document.getElementById("produto");
  sel.innerHTML="<option value=''>Produto</option>";
  data.forEach(p=>{
    sel.innerHTML+=`<option value="${p.id}">${p.codigo}</option>`;
  });
}

document.getElementById("produto").addEventListener("change",e=>{
  produtoSel=produtos.find(p=>p.id==e.target.value);
  if(!produtoSel)return;

  comprimento.value=produtoSel.comprimento_mm;
  pecas_caixa.value=produtoSel.pecas_por_caixa;
  acabamento.value=produtoSel.acabamento;
  peso_caixa.value=(produtoSel.pecas_por_caixa*produtoSel.peso_liquido).toFixed(2);
  recalcular();
});

document.getElementById("kg").addEventListener("input",recalcular);

function recalcular(){
  if(!produtoSel)return;
  const kgv=parseFloat(kg.value||0);
  const qtd=kgv/produtoSel.peso_liquido;
  quantidade.value=qtd.toFixed(0);
  kg_bruto.value=(qtd*produtoSel.peso_liquido).toFixed(2);
}

async function salvar(){
  await supabase.from("zincagem_tratamento").insert({
    op:op.value,
    data:data.value,
    produto_id:produtoSel.id,
    comprimento:produtoSel.comprimento_mm,
    pecas_por_caixa:produtoSel.pecas_por_caixa,
    acabamento:produtoSel.acabamento,
    kg:parseFloat(kg.value),
    quantidade:parseInt(quantidade.value),
    kg_material_bruto:parseFloat(kg_bruto.value),
    peso_caixa:parseFloat(peso_caixa.value),
    entregue:false,
    boleto:false
  });
  location.reload();
}

async function carregarLista(){
  const {data}=await supabase.from("zincagem_tratamento")
    .select("*,produtos(codigo)").order("data",{ascending:false});
  lista.innerHTML="";
  data.forEach(r=>{
    lista.innerHTML+=`
    <tr>
      <td>${r.op}</td>
      <td>${r.data}</td>
      <td>${r.produtos.codigo}</td>
      <td>${r.comprimento}</td>
      <td>${r.pecas_por_caixa}</td>
      <td>${r.acabamento}</td>
      <td>${r.kg}</td>
      <td>${r.kg_material_bruto}</td>
      <td>${r.peso_caixa}</td>
      <td>${r.quantidade}</td>
      <td><button class="btn-status ${r.entregue?'btn-ok':'btn-pendente'}"
        onclick="atualizar(${r.id},'entregue')">${r.entregue?'OK':'Marcar'}</button></td>
      <td><button class="btn-status ${r.boleto?'btn-ok':'btn-pendente'}"
        onclick="atualizar(${r.id},'boleto')">${r.boleto?'OK':'Marcar'}</button></td>
    </tr>`;
  });
}

async function atualizar(id,campo){
  await supabase.from("zincagem_tratamento").update({[campo]:true}).eq("id",id);
  carregarLista();
}

window.onload=async()=>{
  await carregarProdutos();
  await carregarLista();
};
</script>

</body>
</html>
