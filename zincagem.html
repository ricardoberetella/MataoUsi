<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Zincagem / Tratamento</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SUPABASE CDN (PODE EXISTIR MAIS DE UMA VEZ SEM QUEBRAR) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
  margin:0;
  font-family:Segoe UI,Arial;
  background:radial-gradient(circle at top,#0b1224,#020617 70%);
  color:#e5e7eb;
}
header{
  padding:20px 30px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
h1{color:#38bdf8;margin:0;}
.btn{
  padding:8px 14px;
  border-radius:8px;
  border:none;
  cursor:pointer;
}
.btn-azul{background:#38bdf8;color:#000;}
.btn-branco{background:#fff;color:#000;}
.container{padding:0 30px 30px;}
table{width:100%;border-collapse:collapse;}
th,td{padding:10px;border-bottom:1px solid #1e293b;}
th{color:#38bdf8;text-align:left;}

.modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.modal{
  width:900px;
  background:linear-gradient(180deg,#020b1a,#020617);
  border-radius:16px;
  padding:24px;
}
.modal h2{color:#38bdf8;margin-top:0;}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
input,select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #1e293b;
  background:#020617;
  color:#e5e7eb;
}
.footer{
  margin-top:20px;
  display:flex;
  justify-content:flex-end;
  gap:10px;
}
</style>
</head>

<body>

<header>
  <h1>Zincagem / Tratamento</h1>
  <div>
    <button class="btn btn-branco" onclick="window.location.href='menu.html'">← Voltar ao menu</button>
    <button class="btn btn-azul" id="btnNovaOp">+ Nova OP</button>
  </div>
</header>

<div class="container">
  <table>
    <thead>
      <tr>
        <th>OP</th><th>Data</th><th>Peça</th><th>Acab.</th>
        <th>Kg Líq.</th><th>Qtd</th><th>Kg Bruto</th><th>R$/Kg</th><th>Total</th>
      </tr>
    </thead>
    <tbody id="listaOps">
      <tr><td colspan="9">Carregando...</td></tr>
    </tbody>
  </table>
</div>

<!-- MODAL -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h2>Nova OP</h2>

    <div class="grid">
      <input id="op" placeholder="OP">
      <input type="date" id="data">
      <select id="peca"></select>
      <select id="acabamento">
        <option>Zincado</option>
        <option>Tratado</option>
      </select>
      <input id="kg_liquido" placeholder="Kg Líquido">
      <input id="rs_kg" placeholder="R$/Kg">
      <input id="quantidade" placeholder="Quantidade">
      <input id="kg_bruto" placeholder="Kg Bruto" readonly>
      <input id="total" placeholder="Total" readonly style="grid-column:1/3">
    </div>

    <div class="footer">
      <button class="btn btn-branco" id="btnCancelar">Cancelar</button>
      <button class="btn btn-azul">Salvar</button>
    </div>
  </div>
</div>

<script>
/* ========= SUPABASE BLINDADO ========= */
(function(){

  if(!window._supabaseClient){
    window._supabaseClient = window.supabase.createClient(
      "https://uxtgicfuggpuyjybwawa.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV4dGdpY2Z1Z2dwdXlqeWJ3YXdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNjIyNjIsImV4cCI6MjA3ODgzODI2Mn0.bYAyuTccwk21yWiYrFt_v6mWubDWJGVRWT0rJT74fGg"
    );
  }

  const supabase = window._supabaseClient;

  const modalBg = document.getElementById("modalBg");
  const btnNovaOp = document.getElementById("btnNovaOp");
  const btnCancelar = document.getElementById("btnCancelar");
  const peca = document.getElementById("peca");

  btnNovaOp.onclick = async ()=>{
    modalBg.style.display="flex";
    await carregarPecas();
  };
  btnCancelar.onclick = ()=> modalBg.style.display="none";

  async function carregarPecas(){
    peca.innerHTML="<option>Carregando...</option>";
    const {data,error} = await supabase
      .from("produtos")
      .select("id,codigo,descricao,peso_caixa")
      .order("codigo");
    if(error){ alert(error.message); return; }
    peca.innerHTML="<option value=''>Selecione</option>";
    data.forEach(p=>{
      const o=document.createElement("option");
      o.value=p.id;
      o.textContent=`${p.codigo} - ${p.descricao}`;
      o.dataset.peso=p.peso_caixa;
      peca.appendChild(o);
    });
  }

  function calc(){
    const qtd=+quantidade.value||0;
    const peso=+peca.selectedOptions[0]?.dataset.peso||0;
    const rs=+rs_kg.value.replace(",",".")||0;
    kg_bruto.value=(qtd*peso).toFixed(3);
    total.value=(kg_bruto.value*rs).toFixed(2).replace(".",",");
  }

  quantidade.oninput = rs_kg.oninput = calc;

})();
</script>

</body>
</html>
