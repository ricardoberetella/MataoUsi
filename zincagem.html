import { supabase, verificarLogin } from "./auth.js";

/* ========= LOGIN ========= */
document.addEventListener("DOMContentLoaded", async () => {
  const user = await verificarLogin();
  if (!user) return;

  document.getElementById("btnLogout").onclick = async () => {
    await supabase.auth.signOut();
    location.href = "index.html";
  };

  document.getElementById("btnNovaOp").onclick = () => {
    modalBg.style.display = "flex";
    carregarProdutos();
  };

  document.getElementById("btnCancelar").onclick = () => {
    modalBg.style.display = "none";
  };
});

/* ========= UTIL ========= */
const n = v => Number(String(v).replace(",", ".")) || 0;
const f2 = v => v.toLocaleString("pt-BR", { minimumFractionDigits: 2 });
const f3 = v => v.toLocaleString("pt-BR", { minimumFractionDigits: 3 });

/* ========= CARREGAR PRODUTOS ========= */
async function carregarProdutos(){
  const select = document.getElementById("peca");
  select.innerHTML = `<option value="">Selecione</option>`;

  const { data, error } = await supabase
    .from("produtos")
    .select("codigo, descricao, comprimento_mm, quantidade_caixa, peso_caixa")
    .order("codigo");

  if (error) {
    alert(error.message);
    console.error(error);
    return;
  }

  data.forEach(p => {
    const o = document.createElement("option");
    o.value = p.codigo;
    o.textContent = `${p.codigo} - ${p.descricao}`;
    o.dataset.comp = p.comprimento_mm;
    o.dataset.pc = p.quantidade_caixa;
    o.dataset.peso = p.peso_caixa;
    select.appendChild(o);
  });
}

/* ========= AUTO-PREENCHIMENTO ========= */
peca.addEventListener("change", e => {
  const o = e.target.selectedOptions[0];
  if (!o) return;

  comprimento.value = o.dataset.comp;
  pc_caixa.value = o.dataset.pc;
  peso_caixa.value = f3(n(o.dataset.peso));
});

/* ========= C√ÅLCULOS ========= */
rs_kg.addEventListener("input", calcular);
kg_liquido.addEventListener("input", calcular);

function calcular(){
  const qtd = Math.floor(n(kg_liquido.value) / n(peso_caixa.value || 1));
  quantidade.value = qtd;
  kg_bruto.value = f3(qtd * n(peso_caixa.value));
  total.value = f2(n(rs_kg.value) * n(kg_bruto.value));
}
